# HTTP Middleware Test
import "http"

println("Testing HTTP Middleware")
println("=" * 40)
println()

var server = http.Server()

# Add logging middleware
server.use(function(req, next) {
    println("[Middleware 1] Before:", req.method, req.path)
    var res = next(req)
    println("[Middleware 1] After: Status", res["status"])
    return res
})

# Add another middleware
server.use(function(req, next) {
    println("[Middleware 2] Processing request...")
    var res = next(req)
    println("[Middleware 2] Request complete")
    return res
})

# Define routes
server.get("/", function(req) {
    println("[Handler] Handling root request")
    return http.Response(200, "Hello from root!")
})

server.get("/test", function(req) {
    println("[Handler] Handling /test request")
    return http.Response(200, "Test response")
})

server.post("/data", function(req) {
    println("[Handler] Handling POST /data")
    var data = req.json()
    if data is Error {
        return http.Response(400, {"error": "Invalid JSON"})
    }
    return http.Response(201, {"received": data})
})

println("✓ Middleware registered:")
println("  - Logging middleware")
println("  - Processing middleware")
println()
println("✓ Routes registered:")
println("  GET  /")
println("  GET  /test")
println("  POST /data")
println()
println("Starting server on port 3001...")
println()
println("Test with:")
println("  curl http://localhost:3001/")
println("  curl http://localhost:3001/test")
println("  curl -X POST http://localhost:3001/data -d '{\"test\":\"value\"}' -H 'Content-Type: application/json'")
println()
println("Watch the console to see middleware execution order!")
println()

server.start(3001)
